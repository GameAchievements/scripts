(()=>{var b=(s,t,n=".gas-list-entry")=>{let e={ps:{rgx:/playstation/gi},xbox:{rgx:/xbox/gi},steam:{rgx:/steam|pc|windows|mac|linux/gi}};return e.ps.rgx.test(s)&&(t=$(".gas-platform-psn",t).css("display","inherit").parents(n).prop("outerHTML")),e.steam.rgx.test(s)&&(t=$(".gas-platform-steam",t).css("display","inherit").parents(n).prop("outerHTML")),e.xbox.rgx.test(s)&&(t=$(".gas-platform-xbox",t).css("display","inherit").parents(n).prop("outerHTML")),t};var p=document.querySelector("meta[name=domain]")?.content,T=new URLSearchParams(location.search),f=T.get("id")||1,w=0,g,l="#gas-guide";$(".ga-loader-container").show();$("#ga-sections-container").hide();function L(s){let t=$(`${l}-nav`),n=$(`${l}-sections`),e=$(".gas-nav-btn",t).first(),a=$(".gas-section",n).first();for(let c=s.length-1;c>=0;c--){let o=s[c],i=e.clone();i.attr("title",o.title),i.children().first().text(i.text().replace("{|title|}",o.title));let r=c+1;t.prepend(i.attr("href",`${l}-section-${r}`));let m=a.clone(),d=$(".gas-section-title",m);d.text(d.text().replace("{|title|}",`${r} \u203A ${o.title}`));let h=$(".gas-section-content",m);h.html(h.text().replace("{|content|}",o.content)),n.prepend(m.attr("id",`${l.slice(1)}-section-${r}`))}e.remove(),a.remove()}function D(s){let t=`${l}-details`,n=$(t),e=n.prop("outerHTML");console.info(`=== ${t} ===`,s);let a=["id","name","description","achievementId","achievementName","gameId","gameName","profileId","author","createdAt","updatedAt"],c=["comments","upvotes"],o=s.coverURL||s.imageURL;o?.length&&(e=n.css("background-image",`linear-gradient(rgba(255,255,255,0),#030922),
          linear-gradient(rgba(70,89,255,.4),rgba(70,89,255,.4)),
          url(${o})`).prop("outerHTML"));let i=$(".gas-author-cover",e);i?.length&&s.avatar?.length&&(e=showImageFromSrc(i,s.avatar,t)||e),Object.entries(s).forEach(([r,m])=>{a.includes(r)?e=e.replaceAll(`{|${r}|}`,(r.endsWith("At")?gaDate(m):m)||""):c.includes(r)?e=e.replaceAll(`{|${r}|}`,Math.round(m||0)):r==="platform"&&(e=b(m,e,t))}),n.prop("outerHTML",e),L(s.sections)}async function C(){let s=await fetch(`https://${p}/api/guide/${f}`);if(s.status!==200)return;let t=await s.json();return Object.keys(t).length>0&&t.id&&(document.title=`${t.name?.length?t.name:t.id} | ${document.title}`,w=t.achievementId,t.achievementName=achievementNameSlicer(t.achievementName),D(t)),t}function I({listData:s,elemId:t,textKeysToReplace:n}){console.info(`=== ${t} results ===`,s);let e=$(t).prop("outerHTML"),a=$(`${t} .gas-list`),c=$(".gas-list-empty",a);if(s.count>0&&s.results?.length){let o=a.children().first(),i=$(".gas-list-entry",a).first();i.show(),e=i.prop("outerHTML"),a.html(o).append(i),i.hide(),s.results.forEach((r,m)=>{let d=e;Object.entries(r).forEach(([h,u])=>{let x=$(".gas-list-entry-cover",d);if(x.length&&r.imageUrl?.length&&(d=showImageFromSrc(x,r.imageURL)||d),n.includes(h))d=d.replaceAll(`{|${h}|}`,u||"");else if(h==="date"){let{date:v,time:y}=gaDateTime(u);d=d.replaceAll(`{|${h}|}`,`${v} at ${y}`)}}),a.append(d).children().last().removeClass(["bg-light","bg-dark"]).addClass(`bg-${m%2>0?"light":"dark"}`)})}else a.html(c),c.show();a.show()}async function M({listName:s,textKeysToReplace:t}){let n=`${l}-${s}`,a=await(await fetch(`https://${p}/api/guide/${f}/${s}`)).json();$(`.gas-guide-${s}-count`).text(a.count||""),I({listData:a,elemId:n,textKeysToReplace:t})}function k(s){g=s;let t=$(`${l}-btn-like`),n=$(`${l}-btn-like-del`);g?t.hide():n.hide();let e=async()=>{t.attr("disabled",!0),n.attr("disabled",!0);let a=await fetch(`https://${p}/api/guide/${f}/upvote`,{method:"POST",headers:{Authorization:`Bearer ${token}`}}),c=$(`${l}-upvotes-count`),o=g?-1:1;if(g=!g,c.text(Number(c.text()||0)+o),a.status===204){t.attr("disabled",!1).show(),n.hide();return}t.hide(),n.attr("disabled",!1).show()};t.on("click",e),n.on("click",e)}var H=s=>{let t=`${l}-comment-form`;if(s){$(`${l}-btn-add-comment`).hide(),$(t).parent().hide();return}let n=4e3,e=$(".submit-button",t);e.attr("disabled",!0);let a=$("[name=comment]",t),c=e.text(),o=$(".gas-form-error",t),i=$("div",o),r=o.text(),m=$(".gas-form-success",t);a.on("focusout keyup",function(){$(this).val()?.length?($(this).prev("label").removeClass("field-label-missing"),e.removeClass("disabled-button").attr("disabled",!1)):($(this).prev("label").addClass("field-label-missing"),e.addClass("disabled-button").attr("disabled",!0))}),e.on("click",async d=>{if(d.preventDefault(),!a.val().length){o.show(),i.text("Please write your comment in the box above"),setTimeout(()=>{o.hide(),i.text(r)},n);return}isUserInputActive=!1,$("input",t).attr("disabled",!0),e.text(e.data("wait"));let h=await fetch(`https://${p}/api/guide/${f}/comment`,{method:"POST",headers:{Authorization:`Bearer ${token}`,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({comment:a.val()})}),u=await h.json();if(h.status!==201){o.show(),i.text(u?.message),setTimeout(()=>{o.hide(),i.text(r),$("input",t).attr("disabled",!1),e.text(c)},n);return}$("form",t).hide(),m.attr("title",u?.message).show(),setTimeout(()=>{location.reload()},n)})};async function j(){if(!token||!w)return;let s=await fetch(`https://${p}/api/achievement/${w}/guide-auth-user-data?id=${f}`,{headers:{Authorization:`Bearer ${token}`}});if(s.status!==200){$(`${l}-nav-auth`).hide(),$(`${l}-comment-form`).parent().hide();return}let t=await s.json(),n=$(`${l}-btn-edit`);t.ownedGuideId>0?n.attr("href",`/guide-form?id=${t.ownedGuideId}`).show():n.hide(),k(t.hasLike),H(t.hasComment)}$().ready(async()=>{if(await auth0Bootstrap(),await C()){await j(),await M({listName:"comments",numKeysToReplace:[],textKeysToReplace:["profileId","author","comment"]}),$(".ga-loader-container").hide(),$("#ga-sections-container").show(),$("#gas-wf-tab-activator").click();return}location.replace("/guides")});})();
