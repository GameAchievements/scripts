(()=>{var T=(e,t,o=".gas-list-entry")=>{let s={ps:{rgx:/playstation/gi},xbox:{rgx:/xbox/gi},steam:{rgx:/steam|pc|windows|mac|linux/gi}};return s.ps.rgx.test(e)&&(t=$(".gas-platform-psn",t).css("display","inherit").parents(o).prop("outerHTML")),s.steam.rgx.test(e)&&(t=$(".gas-platform-steam",t).css("display","inherit").parents(o).prop("outerHTML")),s.xbox.rgx.test(e)&&(t=$(".gas-platform-xbox",t).css("display","inherit").parents(o).prop("outerHTML")),t};var F=e=>{if(e<25)return"common";if(e<50)return"rare";if(e<75)return"very-rare";if(e>=75)return"ultra-rare"},M=(e,t,o=".hero-section-achievement")=>{let s=F(e);return t=$(".rarity-tag-wrapper",t).children(`:not(.gas-rarity-tag-${s})`).hide().parents(o).prop("outerHTML"),t};var R=e=>{let t=s=>`0${s}`.slice(-2),o=new Date(e);return`${o.getFullYear()} . ${t(o.getMonth()+1)} . ${t(o.getDate())}`};var S=document.querySelector("meta[name=domain]")?.content,W=document.querySelector("meta[name=forum-domain]")?.content,G=new URLSearchParams(location.search),U=G.get("id")||1044,C=`https://${S}/api/game/${U}`,y="#gas-gh",A=`${y}-versions-dropdown`,H=4e3,P=["all","playstation","xbox","steam"],L;$(".ga-loader-container").show();$("#ga-sections-container").hide();$("#gas-gh-top-old").remove();$("#gas-gh-about-old").remove();function j(e,t){let o=$(t),s=o.prop("outerHTML");console.info(`=== ${t} ===`,e);let p=["name","igdbId","description"],c=["ownersCount","achievementsCount","gaReviewScore","versionsCount","completion"],f=["releaseDate"],r=[],a=["developers","publishers","franchises","engines","modes","genres","themes","series","supportedLanguages","playerPerspectives"],m=[...p,...f],l=[...c,...r];t.endsWith("top")&&(e.coverURL||e.imageURL)?.length&&(s=o.css("background-image",`linear-gradient(rgba(255,255,255,0),#030922),
          linear-gradient(rgba(70,89,255,.4),rgba(70,89,255,.4)),
          url(${e.coverURL||e.imageURL})`).prop("outerHTML")),$(".gas-img",s).each((i,u)=>{e.imageURL?.length&&(s=showImageFromSrc($(u),e.imageURL,t)||s)}),Object.entries(e).forEach(([i,u])=>{m.find(n=>n.toLowerCase()===i.toLowerCase())?s=s.replaceAll(`{|${i}|}`,u?.length?i.endsWith("Date")?R(u):u:"N.A."):l.find(n=>n.toLowerCase()===i.toLowerCase())?s=s.replaceAll(`{|${i}|}`,Math.round(u||0)):i==="platformsInGACount"&&t.endsWith("top")?s=T(u?.length?u:e.importedFromPlatforms,s,t):a.includes(i)&&(s=s.replaceAll(`{|${i}|}`,u?.length?u.join(", "):"N.A."))}),o.prop("outerHTML",s);let w=Object.keys(e),b=[...c,...m,...a].filter(i=>!w.includes(i));b.forEach(i=>{$(`div:contains({|${i}|})`).parent(".entry-wrapper").remove()}),t.endsWith("about")&&b.length>0&&$(".about-game-entry-div").each(function(){$(this).find(".entry-wrapper").length===0&&$(this).remove()})}async function N(){let e=await fetch(C);if(!e.ok){location.replace("/games");return}let t=await e.json();if(Object.keys(t).length>0&&t.id){if(t.versionDetails&&t.versionDetails.defaultVersion!==Number(U)){location.replace(`/game?id=${t.versionDetails.defaultVersion}`);return}document.title=`${t.name?.length?t.name:t.id} | ${document.title}`,t.igdbId?.length?["top","about"].forEach(o=>{j(t,`${y}-${o}`)}):($(`${y}-about,${y}-igdb-id,[href="${y}-about"]`).remove(),j(t,`${y}-top`))}return t}async function V(){let e=[],t=`${y}-forum-threads`;if(L.forumCategoryID){let o=await fetch(`https://${W}/api/category/${L.forumCategoryID}`);o.ok&&(e=(await o.json()).topics.slice(0,5)),e=e.map(s=>({id:s.cid,title:s.title,topic_id:s.tid,author_name:s.user.username,imageURL:s.user.picture?.toLowerCase().includes("http")?new DOMParser().parseFromString(s.user.picture,"text/html").documentElement.textContent:"https://uploads-ssl.webflow.com/6455fdc10a7247f51c568c32/64b50ee999d75d5f75a28b08_user%20avatar%20default.svg",category_name:s.category.name,category_id:s.category.cid,views:s.viewcount,upvotes:s.upvotes,replies:s.postcount}))}_({listData:e,elemId:t,numKeysToReplace:["replies","views","upvotes"],textKeysToReplace:["title","author_name","category_name","topic_id","category_id"]}),$(`${t} .ga-loader-container`).hide()}function _({listData:e,elemId:t,numKeysToReplace:o,textKeysToReplace:s}){console.info(`=== ${t} results ===`,e);let p=$(t).prop("outerHTML"),c=$(`${t} .gas-list`),f=$(`${t} .gas-list-empty`),r=$(".gas-list-entry",c).first();if(r.show(),p=r.prop("outerHTML"),r.hide(),e?.length&&p?.length)c.html(r),e.forEach((a,m)=>{let l=p;l=l.replaceAll("{|idx|}",m+1),Object.entries(a).forEach(([w,b])=>{if(a.gameIconURL?.length&&!isSteamImage(a.gameIconURL)){let i=$(".gas-list-entry-cover-game",l);i?.length&&(l=showImageFromSrc(i,a.gameIconURL)||l)}if((a.iconURL?.length||a.imageURL?.length)&&!isXboxEdsImage(a.imageURL)&&!isSteamImage(a.imageURL)&&!isSteamImage(a.iconURL)){let i=$(".gas-list-entry-cover",l);i?.length&&(l=t.includes("list-games")?i.css("background-image",`url(${a.imageURL})`).parents(".gas-list-entry").prop("outerHTML"):showImageFromSrc(i,a.iconURL||a.imageURL)||l)}s.includes(w)?l=l.replaceAll(`{|${w}|}`,(w.endsWith("At")?R(b):cleanupDoubleQuotes(b))||""):o.includes(w)?l=l.replaceAll(`{|${w}|}`,Math.round(b||0)):w==="lastPlayed"?l=l.replaceAll(`{|${w}|}`,R(b)):(w==="importedFromPlatform"||w==="platform")&&(l=T(b,l))}),c.append(l)});else{e?.length&&!p?.length&&console.error(`${t} template issue (missing a '.gas-' class?)`);let a=f.children().first(),m=a.prop("outerHTML").replaceAll("{|name|}",L.name);a=a.prop("outerHTML",m),$(t).html(f),f.show()}c.css("display","flex")}function q({listData:e,elemId:t,numKeysToReplace:o,textKeysToReplace:s,tabCounts:p,tabMatcher:c}){let f=$(`${t} .gas-list-tabs`);console.info(`=== ${t} results ===`,e);let r=f.prop("outerHTML");p||(c="platform",p={all:e.length,playstation:e.filter(a=>a[c].toLowerCase()==="playstation")?.length,xbox:e.filter(a=>a[c].toLowerCase()==="xbox")?.length,steam:e.filter(a=>a[c].toLowerCase()==="steam")?.length},P.forEach(a=>{r=r.replaceAll(`{|${a}Cnt|}`,p[a])||"0"})),f.prop("outerHTML",r),Object.keys(p).forEach(a=>{let m=$(`${t} .gas-list-${a}`),l=$(".gas-list-empty",m);if(p[a]>0){let w=m.children().first(),b=$(".gas-list-entry",m).first();b.show(),r=b.prop("outerHTML"),m.html(w).append(b),b.hide(),(a==="all"?e:e.filter(i=>i[c]?.toLowerCase()===a)).forEach((i,u)=>{let n=r;Object.entries(i).forEach(([h,g])=>{let d=$(".gas-list-entry-cover",n);if(d&&i.iconURL?.length&&(n=showImageFromSrc(d,i.iconURL)||n),t.endsWith("achievements")&&h==="name")n=n.replaceAll("{|name|}",achievementNameSlicer(g)||"N.A.");else if(s.includes(h))n=n.replaceAll(`{|${h}|}`,(h.endsWith("At")?R(g):g)||"");else if(o.includes(h))n=n.replaceAll(`{|${h}|}`,Math.round(g||0));else if(h==="rating"){n=n.replaceAll(`{|${h}|}`,Math.round(g||0));let v=$(".gas-list-entry-rating",n);v.length&&(n=v.prepend(ratingSVG(g)).parents(".gas-list-entry").prop("outerHTML"))}else h==="platform"?n=T(g,n):h==="rarity"&&(n=showRarityTag(g,n))}),listTemplateAppend(m,n,u)})}else m.html(l),l.show()})}function B({listData:e,elemId:t}){let o=$(t+"-bars"),s=[],p=["positive","mixed","negative"];if(e.length){p.forEach(f=>{s=e.filter(m=>m.classification?.toLowerCase()===f);let r=$(`.gas-bar-${f}`,o);r.length&&r.css("width",`${100*(s.length/e.length)||1}%`);let a=$(`.gas-bar-text-${f}`,o);a.length&&a.text(s?.length)});let c=Math.round(e.map(f=>f.rating).reduce((f,r)=>f+r)/e.length);$(".gas-avg-rate-wrapper").each((f,r)=>{$(r).prepend(ratingSVG(c)),$(".gas-avg-rate-text",r).text(c)})}else p.forEach(c=>{$(`.gas-bar-${c}`,o).css("width","1%")}),$(".gas-avg-rate-wrapper").each((c,f)=>{$(f).prepend(ratingSVG(0)),$(".gas-avg-rate-text",f).text("-")})}async function E({listName:e,numKeysToReplace:t,textKeysToReplace:o,tabs:s,tabMatcher:p}){let c=`${y}-${e}`,r=await(await fetch(`${C}/${e}`)).json();if(Array.isArray(r)||r.length>0){let a;switch(Array.isArray(s)&&(a={},s.forEach(m=>{a[m]=m==="all"?r.length:r.filter(l=>l[p]?.toLowerCase()===m)?.length})),e){case"reviews":B({listData:r,elemId:c}),$(".gas-count-reviews").each((m,l)=>{$(l).text($(l).text().replace("{|reviewsCnt|}",r.length)),m>0&&$(l).text($(l).text().replace(`{|${s[m]}ReviewsCnt|}`,a[s[m]]))});break;case"guides":$(`${y}-top .gas-count-guides`).text(r.length);break;default:break}q({listData:r,elemId:c,numKeysToReplace:t,textKeysToReplace:o,tabCounts:a,tabMatcher:p})}}function z({listsData:e,elemId:t,numKeysToReplace:o,textKeysToReplace:s}){console.info(`=== ${t} results ===`,e),$(`${t} .gas-list-first, ${t} .gas-list-latest`).each((c,f)=>{let r=$(f),a=r.prop("outerHTML"),m=$(".gas-list-empty",r),l=r.children().first(),w=$(".gas-list-entry",r).first();r.html(l);let b=e[c===0?"firstAchievers":"latestAchievers"];b?.length>0?(w.show(),r.append(w),a=w.prop("outerHTML"),w.hide(),b.forEach((i,u)=>{let n=a;Object.entries(i).forEach(([h,g])=>{let d=$(".gas-list-entry-cover",n);if(d&&i.iconURL?.length&&(n=showImageFromSrc(d,i.avatar)||n),n=n.replaceAll("{|idx|}",u+1),h==="unlockedAt"){let{date:v,time:x}=gaDateTime(g);n=n.replaceAll("{|unlockedDt|}",v||"N.A."),n=n.replaceAll(`{|${h}|}`,x||"N.A.")}else s.includes(h)?n=n.replaceAll(`{|${h}|}`,g||""):o.includes(h)&&(n=n.replaceAll(`{|${h}|}`,Math.round(g||0)))}),listTemplateAppend(r,n,u)})):(r.append(m),m.show())})}async function J({listName:e,numKeysToReplace:t,textKeysToReplace:o}){let s=`${y}-${e}`,c=await(await fetch(`${C}/${e}`)).json();z({listsData:c,elemId:s,numKeysToReplace:t,textKeysToReplace:o})}async function K(e,t){let o=`${y}-achievements`,s=$(`${o} .ga-loader-container`),p=$(`${o} .${t===1?"psn":"xbox"}-achievement-list`),c=$(`${o} .empty-state`);c.hide(),p.hide(),s.show();let f={Authorization:`Bearer ${token}`},a=await(await fetch(`https://${S}/api/game/${e}/achievements${t?`?platform=${t}`:""}`,{headers:token?f:{}})).json();console.info(`=== ${o} results ===`,a);let m=["name","description"],l=["id","score","achieversCount","gAPoints"],w=p.parent(),b=p.children().first(),i=$(".gh-row",p).first();i.show();let u=i.prop("outerHTML");p.html(b).append(i),a.length>0?(i.hide(),a.forEach((n,h)=>{let g=u;Object.entries(n).forEach(([d,v])=>{let x=$(".gas-list-entry-cover",g);x&&n.iconURL?.length&&(g=showImageFromSrc(x,n.iconURL,".gh-row")||g),d==="name"?g=g.replaceAll("{|name|}",achievementNameSlicer(v)||"N.A."):m.includes(d)?g=g.replaceAll(`{|${d}|}`,(d.endsWith("At")?R(v):v)||""):l.includes(d)?g=g.replaceAll(`{|${d}|}`,Math.round(v||0)):d==="rarity"?g=M(v,g,".gh-row"):d==="trophyType"&&t===1?g=showTrophy(v,g):d==="userProgress"&&(g=showAchievementUnlocked(v,g))}),listTemplateAppend(p,g,h,n.userProgress?.unlocked)}),s.hide(),w.removeClass("hidden"),p.css({display:"flex","flex-direction":"column"}),c.hide()):(s.hide(),p.hide(),c.show())}async function Y(e){let t=$(e.target);$(`${A}-options,${A}-toggle`).removeClass("w--open");let o=Number(t.data("version-id")),s=Number(platformNameIdMap(t.data("platform")?.toLowerCase())||0);$(`${A}-text-selected`).text(t.text()),K(o,s)}async function Q(){let e="versions",t=`${y}-${e}`;if(!L.versionDetails){let l=Number(L.platforms.length>=1?platformNameIdMap(L.platforms[0]):0);return $(A).remove(),K(L.id,l)}let s=await(await fetch(`${C}/${e}`)).json(),p=["achievementsCount"],c=["gameId","externalGameId","region"];console.info(`=== ${t} results ===`,s);let f=$(t).prop("outerHTML"),r=$(`${t} .gas-list`),a=$(`${t} .heading-description-wrapper`).children().last(),m=a.prop("outerHTML");if(m&&(m=m.replaceAll("{|name|}",L.name),a.prop("outerHTML",m)),s.length){let l=r.children().first(),w=$(".gas-list-entry",r).first();w.show(),f=w.prop("outerHTML"),r.html(l).append(w),w.hide();let b="gas-version-option",i=$(`${A}-options`).children().first();i.addClass(b),s.forEach((u,n)=>{let h=i.clone(),g=u.consoles[0]+(u.region?` \u2014 ${u.region} `:"");h.data("version-id",u.gameId).data("version-external-id",u.externalGameId).data("platform",u.platform).text((u.name?.length?`${u.name} | `:"")+g),$(`${A}-options`).append(h);let d=f;Object.entries(u).forEach(([v,x])=>{c.includes(v)?d=d.replaceAll(`{|${v}|}`,x||"?"):p.includes(v)?d=d.replaceAll(`{|${v}|}`,Math.round(x||0)):v==="name"?d=d.replaceAll(`{|${v}|}`,u.name?.length?u.name:g):v==="platform"?d=T(x,d):v==="consoles"&&(d=$(".gas-console-tags",d).html(x.map(I=>{let D=I.toLowerCase();return`<div class="console-${D.startsWith("ps")?"playstation":D.slice(0,4)}">${I}</div>`})).parents(".gas-list-entry").prop("outerHTML"))}),listTemplateAppend(r,d,n)}),i.remove(),$(`.${b}`).on("click",Y)}r.css("display","flex"),$(`${t}-tab .gas-list-empty`).show(),$(`${t},${t}-tab-btn`).css("display","flex")}var X=()=>{if($("#official-review-game-title").text(L.name),$(`${y}-top-ga-score`).prepend(ratingSVG(0)),$(`${y}-top-ga-score-text`).text("-"),!L?.gaReviewURL?.length)return;let e=`${y}-official-review`;if($(e).css("display","flex"),$(`${e}-placeholder`).hide(),$(`${e}-url`).attr("href",L.gaReviewURL),L?.gaReviewSummary?.length&&$(`${e}-summary`).text(L.gaReviewSummary),L?.gaReviewScore){let t=Math.round(L.gaReviewScore),o=ratingSVG(t);$(`${e}-score-text`).text(t),$(`${e}-score-bg`).replaceWith(o),$(`${y}-top-ga-score .bg-review-score`).replaceWith(o),$(`${y}-top-ga-score-text`).text(t)}else $(`${e}-score`).parent().remove()},Z=async()=>{let e=`${y}-review-form`;if((await fetch(`${C}/review`,{headers:{Authorization:`Bearer ${token}`}})).status===200){$(e).remove();return}let o=$(".submit-button",e);o.attr("disabled",!0);let s=$("[name=title]",e),p=$("[name=content]",e),c=$("[name][required]",e),f=o.val(),r=$(".gas-form-error",e),a=$("div",r),m=r.text(),l=$(".gas-form-success",e),w=$(".gas-rating-scale",e),b=$(".gas-rating-selected",e);ratingScale(w,b);let i=!1,u=()=>{i&&Number(b.data("rate"))&&o.removeClass("disabled-button").attr("disabled",!1)};c.on("focusout keyup",function(){c.each(function(){$(this).val()?.length?(i=!0,$(this).prev("label").removeClass("field-label-missing")):(i=!1,$(this).prev("label").addClass("field-label-missing"),o.addClass("disabled-button").attr("disabled",!0))}),u()}),$("li",w).one("click",function(){w.parent().prev("label").removeClass("field-label-missing"),u()}),o.on("click",async n=>{n.preventDefault();let h=Number(b.data("rate")||0);if(!h||!s.val()?.length||!p.val().length){r.show(),a.text("Please choose a rating and fill-in required fields"),setTimeout(()=>{r.hide(),a.text(m)},H);return}isUserInputActive=!1,$("input",e).attr("disabled",!0),o.val(o.data("wait"));let g={title:s.val(),content:p.val(),rating:h},d=await fetch(`${C}/review`,{method:"POST",headers:{Authorization:`Bearer ${token}`,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(g)}),v=await d.json();if(d.status!==201){r.show(),a.text(v?.message),setTimeout(()=>{r.hide(),a.text(m),$("input",e).attr("disabled",!1),o.val(f)},H);return}$("form",e).hide(),l.attr("title",v?.message).show(),setTimeout(()=>{location.reload()},H)})};async function O(e,t=""){let o=$(e).prop("outerHTML");P.forEach(async s=>{let p=$(`${e} .gas-list-${s}`),c=0;switch(s){case"playstation":c=1;break;case"xbox":c=2;break;case"steam":c=3;break;default:break}let f={gameId:U};c&&(f.type=c),t.length&&(f.q=t);let a=await(await fetch(`https://${S}/api/leaderboard${Object.keys(f)?.length?`?${new URLSearchParams(f).toString()}`:""}`)).json(),m=["profileId","name"],l=["totalAchievements","gaPoints"];switch(c){case 1:l.push("silver","bronze","gold","platinum");break;case 2:l.push("gamescore");break;case 3:l.push("games");break}let w=$(".gas-list-empty",p);if(a.count>0&&a.results?.length){let b=p.children().first(),i=$(".gas-list-entry",p).first();i.show(),o=i.prop("outerHTML"),p.html(b).append(i),i.hide(),a.results.forEach((u,n)=>{let h=o;h=h.replaceAll("{|idx|}",n+1),Object.entries(u).forEach(([g,d])=>{if(g==="iconURL"){let v=$(".gas-list-entry-cover",h);v?.length&&d?.length&&(h=showImageFromSrc(v,d)||h)}else if(g==="recentlyPlayed"){!c&&d?.platform?.length&&(h=T(d?.platform,h));let v=$(".gas-list-entry-cover-game",h);v?.length&&d?.iconURL?.length&&(h=showImageFromSrc(v,d.iconURL)||h)}else m.includes(g)?h=h.replaceAll(`{|${g}|}`,d||""):l.includes(g)&&(h=h.replaceAll(`{|${g}|}`,Math.round(d||0)))}),listTemplateAppend(p,h,n)})}else p.html(w),w.show()})}$().ready(async()=>{if(await auth0Bootstrap(),L=await N(),L){X(),Z(),setupListSearch(`${y}-leaderboard`,O),await Promise.all([await Q(),await O(`${y}-leaderboard`),await E({listName:"guides",numKeysToReplace:["id","commentsCount","viewsCount","likesCount"],textKeysToReplace:["profileId","name","description","author","updatedAt"]}),await E({listName:"reviews",numKeysToReplace:["id","likesCount"],textKeysToReplace:["profileId","name","content","author","classification","updatedAt"],tabs:["all","positive","mixed","negative"],tabMatcher:"classification"}),await J({listName:"achievers",numKeysToReplace:["id","achievementId"],textKeysToReplace:["profileId","achievementName","playerName","name"]}),await V()]),$(".ga-loader-container").hide(),$("#ga-sections-container").show(),$("#gas-wf-tab-activator").click();return}});})();
