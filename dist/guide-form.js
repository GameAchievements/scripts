(()=>{var f=e=>{let t=o=>`0${o}`.slice(-2),s=new Date(e);return`${s.getFullYear()} . ${t(s.getMonth()+1)} . ${t(s.getDate())}`};var y=e=>{if(!e)return"N.A.";let t=e.lastIndexOf(" | ");return t>0?e.slice(0,t):e};function d(e,t="#gas-guide-details"){let s=$(t),o=s.prop("outerHTML");console.info(`=== ${t} ===`,e);let r=["id","name","achievementId","achievementName","gameId","gameName"],l=e.coverURL||e.imageURL;l?.length&&t.endsWith("details")&&(o=s.css("background-image",`linear-gradient(rgba(255,255,255,0),#030922),
          linear-gradient(rgba(70,89,255,.4),rgba(70,89,255,.4)),
          url(${l})`).prop("outerHTML")),Object.entries(e).forEach(([a,n])=>{a==="achievementName"?o=o.replaceAll(`{|${a}|}`,y(n)):r.includes(a)&&(o=o.replaceAll(`{|${a}|}`,(a.endsWith("At")?f(n):n)||""))}),s.prop("outerHTML",o)}async function M(e,t){let o=await(await fetch(`https://${e}/api/achievement/${t}`)).json();Object.keys(o).length>0&&o.id&&(document.title=`Achievement ${o.name?.length?o.name:o.id} | ${document.title}`,o.achievementName=o.name,d(o),d(o,"#gas-guide-form"))}async function T(e,t){let s=await fetch(`https://${e}/api/guide/${t}`);return guideFetchedData=await s.json(),Object.keys(guideFetchedData).length>0&&guideFetchedData.id&&(document.title=`${guideFetchedData.name?.length?guideFetchedData.name:guideFetchedData.id} | ${document.title}`,d(guideFetchedData),d(guideFetchedData,"#gas-guide-form")),guideFetchedData}var A=(e,t)=>t?(isUserInputActive=!0,!0):!1,P=e=>{if((e.hasClass("gas-form-tinymce")?tinyMCE.get(e.attr("id")).getContent():e.val())?.length)return e.prev("label").removeClass("field-label-missing");e.prev("label").addClass("field-label-missing")};function g(e,t="#gas-guide-form"){let s=!1,o=!1;e?.length&&P(e);for(let r of $("input[name][required]",t))if(s=A($(r),$(r).val()?.length),!s)break;for(let r of $(".gas-form-tinymce",t))if(o=A($(r),tinyMCE.get($(r).attr("id")).getContent()?.length),!o)break;s&&o?$(`${t}-btn-submit`).removeClass("disabled-button").attr("disabled",!1):$(`${t}-btn-submit`).addClass("disabled-button").attr("disabled",!0)}var v=document.querySelector("meta[name=domain]")?.content,H=new URLSearchParams(window.location.search),p=Number(H.get("id"))||0,w=p>0,h=Number(H.get("achievementId"))||0,c,O="#gas-guide",i=`${O}-form`,b=4e3,I=4,u=2,R=$(".gas-form-section",i).last().clone(),x="section-2";$(".ga-loader-container").show();$("#ga-sections-container").hide();var S,C={selector:".gas-form-tinymce",height:200,menubar:!1,toolbar_mode:"floating",plugins:"link image lists",toolbar:"undo redo | bold italic underline | numlist bullist",content_style:"body { font-family:Gantari,sans-serif; font-size:1rem }",setup:e=>{e.on("Paste Change input Undo Redo",t=>{clearTimeout(S),S=setTimeout(()=>g($(e.targetElm)),100)})}};function U(){if(confirm("Do you want to remove this section?")){g();let e=$(this).parents(".gas-form-section");tinyMCE.get($(".gas-form-tinymce",e).attr("id")).remove(),e.remove(),u--,$(".gas-form-section label[for$=-title]",i).each((t,s)=>$(s).text(`${t+1}${$(s).text().slice(1)}`)),u<=I&&$(".gas-form-section-add",i).show()}}async function L(){u++,$(`${i}-btn-submit`).addClass("disabled-button").attr("disabled",!0);let e=R.clone().show(),t=`section-${u}`;$(`label[for=${x}-title]`,e).text(`${u} \u203A section name*`).attr("for",`${t}-title`),$(`[name=${x}-title]`,e).attr("name",`${t}-title`).on("focusout keyup",function(){g($(this))}),$(`label[for=${x}-content]`,e).attr("for",`${t}-content`);let s=`${t}-content`;$(".gas-form-tinymce",e).attr("id",s).attr("name",s).attr("data-name",s),$(".gas-form-section-del",e).on("click",U),$(".gas-form-sections",i).append(e),C.selector=`#${s}`,await tinymce.init(C),u>I&&$(".gas-form-section-add",i).hide()}async function E(){$(".gas-form-tinymce",R).removeAttr("id"),await tinymce.init(C),w&&c?.id===p&&($("[name=guide-title]",i).val(c.name),$("[name=guide-description]",i).val(c.description),c.sections.forEach(async(l,a)=>{a>1&&a<c.sections.length&&await L(),$(`[name=section-${a+1}-title]`).val(l.title),tinyMCE.get(`section-${a+1}-content`).setContent(l.content)})),$(".gas-form-section-add",i).on("click",L),$(".gas-form-section-del",i).on("click",U),$(`${i}-btn-cancel`,i).on("click",l=>{l.preventDefault();let a=$("#gas-popup-leave-confirmation");a.css({opacity:1,display:"flex"}),$(".gas-popup-btn-close",a).one("click",n=>{n.preventDefault(),a.hide()}),$(".gas-popup-btn-leave",a).one("click",n=>{n.preventDefault(),isUserInputActive=!1,a.hide(),m()})}),$(`${i}-btn-submit`).attr("disabled",!0);let e=$(`${i}-btn-submit`).val(),t=$(".gas-form-error",i),s=$("div",t),o=t.text(),r=$(".gas-form-success",i);$("input[name][required]",i).on("focusout keyup",function(){g($(this))}),$(`${i}-btn-submit`).on("click",async l=>{l.preventDefault(),$(`${i}-btn-submit`).addClass("disabled-button").attr("disabled",!0),isUserInputActive=!1,$(`${i}-btn-submit`).val($(`${i}-btn-submit`).data("wait"));let a=[];$(".gas-form-section",i).each(function(){a.push({title:$("input[name$=-title]",this).val(),content:tinyMCE.get($(".gas-form-tinymce",this).attr("id")).getContent()})});let n={author:"GA user",title:$("[name=guide-title]",i).val(),description:$("[name=guide-description]",i).val(),sections:a},D="POST",F=`https://${v}/api/guide`;if(w)F+=`/${p}`,D="PUT",n.author=c.author,n.profileId=c.profileId;else{if(!userProfileData){t.show(),s.text("Issue on accessing your data for saving. Please try again later."),$(`${i}-btn-submit`).val(e),setTimeout(()=>{t.hide(),s.text(o)},b);return}n.profileId=userProfileData.id,n.author=userProfileData.name,n.achievementId=h}let k=await fetch(F,{method:D,headers:{Authorization:`Bearer ${token}`,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)}),N=await k.json();if(![200,201].includes(k.status)){t.show(),s.text(N?.message),$(`${i}-btn-submit`).val(e).removeClass("disabled-button").attr("disabled",!1),setTimeout(()=>{t.hide(),s.text(o)},b);return}r.show(),$(`${i}-btn-submit`).val(e),setTimeout(()=>{$(`${i}-fields`).hide()},b/5),setTimeout(()=>{isUserInputActive=!1,r.hide(),m()},b)})}function m(){window.location.replace(w?`/guide?id=${p}`:h>0?`/achievement?id=${h}`:"/guides")}$(async()=>{if(await auth0Bootstrap(),!token){console.log("User not authenticated"),m();return}if(w){if(c=await T(v,p),c?.achievementId>0){let e=await fetch(`https://${v}/api/achievement/${c.achievementId}/guide-auth-user-data`,{headers:{Authorization:`Bearer ${token}`}});if(e.status!==200){console.log("User not found/issue, cannot access to guide edition"),m();return}if(!(await e.json()).ownedGuideId){console.log("This form does not belong to the creator"),m();return}}}else if(h>0)await M(v,h);else{console.log("no valid parameter provided"),m();return}await E(),$(".ga-loader-container").hide(),$("#ga-sections-container").show()});})();
