(()=>{var f=e=>{let t=r=>`0${r}`.slice(-2),o=new Date(e);return`${o.getFullYear()} . ${t(o.getMonth()+1)} . ${t(o.getDate())}`};var w=e=>{if(!e)return"N.A.";let t=e.lastIndexOf(" | ");return t>0?e.slice(0,t):e};function u(e,t="#gas-guide-details"){let o=$(t),r=o.prop("outerHTML");console.info(`=== ${t} ===`,e);let n=["id","name","achievementId","achievementName","gameId","gameName"],l=e.coverURL||e.imageURL;l?.length&&t.endsWith("details")&&(r=o.css("background-image",`linear-gradient(rgba(255,255,255,0),#030922),
          linear-gradient(rgba(70,89,255,.4),rgba(70,89,255,.4)),
          url(${l})`).prop("outerHTML"));for(let[s,i]of Object.entries(e))s==="achievementName"?r=r.replaceAll(`{|${s}|}`,w(i)):n.includes(s)&&(r=r.replaceAll(`{|${s}|}`,(s.endsWith("At")?f(i):i)||""));o.prop("outerHTML",r)}async function D(e,t){let r=await(await fetch(`https://${e}/api/achievement/${t}`)).json();Object.keys(r).length>0&&r.id&&(document.title=`Achievement ${r.name?.length?r.name:r.id} | ${document.title}`,r.achievementName=r.name,u(r),u(r,"#gas-guide-form"))}async function M(e,t){let o=await fetch(`https://${e}/api/guide/${t}`);return guideFetchedData=await o.json(),Object.keys(guideFetchedData).length>0&&guideFetchedData.id&&(document.title=`${guideFetchedData.name?.length?guideFetchedData.name:guideFetchedData.id} | ${document.title}`,u(guideFetchedData),u(guideFetchedData,"#gas-guide-form")),guideFetchedData}var k=(e,t)=>t?(isUserInputActive=!0,!0):!1,P=e=>{if((e.hasClass("gas-form-tinymce")?tinyMCE.get(e.attr("id")).getContent():e.val())?.length)return e.prev("label").removeClass("field-label-missing");e.prev("label").addClass("field-label-missing")};function d(e,t="#gas-guide-form"){let o=!1,r=!1;e?.length&&P(e);for(let n of $("input[name][required]",t))if(o=k($(n),$(n).val()?.length),!o)break;for(let n of $(".gas-form-tinymce",t))if(r=k($(n),tinyMCE.get($(n).attr("id")).getContent()?.length),!r)break;o&&r?$(`${t}-btn-submit`).removeClass("disabled-button").attr("disabled",!1):$(`${t}-btn-submit`).addClass("disabled-button").attr("disabled",!0)}var v=document.querySelector("meta[name=domain]")?.content,S=new URLSearchParams(window.location.search),h=Number(S.get("id"))||0,x=h>0,g=Number(S.get("achievementId"))||0,c,N="#gas-guide",a=`${N}-form`,b=4e3,I=4,m=2,U=$(".gas-form-section",a).last().clone(),y="section-2";$(".ga-loader-container").show();$("#ga-sections-container").hide();var L,C={selector:".gas-form-tinymce",height:200,menubar:!1,toolbar_mode:"floating",plugins:"link image lists",toolbar:"undo redo | bold italic underline | numlist bullist",content_style:"body { font-family:Gantari,sans-serif; font-size:1rem }",setup:e=>{e.on("Paste Change input Undo Redo",t=>{clearTimeout(L),L=setTimeout(()=>d($(e.targetElm)),100)})}};function R(){if(confirm("Do you want to remove this section?")){d();let e=$(this).parents(".gas-form-section");tinyMCE.get($(".gas-form-tinymce",e).attr("id")).remove(),e.remove(),m--,$(".gas-form-section label[for$=-title]",a).each((t,o)=>$(o).text(`${t+1}${$(o).text().slice(1)}`)),m<=I&&$(".gas-form-section-add",a).show()}}async function H(){m++,$(`${a}-btn-submit`).addClass("disabled-button").attr("disabled",!0);let e=U.clone().show(),t=`section-${m}`;$(`label[for=${y}-title]`,e).text(`${m} \u203A section name*`).attr("for",`${t}-title`),$(`[name=${y}-title]`,e).attr("name",`${t}-title`).on("focusout keyup",function(){d($(this))}),$(`label[for=${y}-content]`,e).attr("for",`${t}-content`);let o=`${t}-content`;$(".gas-form-tinymce",e).attr("id",o).attr("name",o).attr("data-name",o),$(".gas-form-section-del",e).on("click",R),$(".gas-form-sections",a).append(e),C.selector=`#${o}`,await tinymce.init(C),m>I&&$(".gas-form-section-add",a).hide()}async function V(){$(".gas-form-tinymce",U).removeAttr("id"),await tinymce.init(C),x&&c?.id===h&&($("[name=guide-title]",a).val(c.name),$("[name=guide-description]",a).val(c.description),c.sections.forEach(async(l,s)=>{s>1&&s<c.sections.length&&await H(),$(`[name=section-${s+1}-title]`).val(l.title),tinyMCE.get(`section-${s+1}-content`).setContent(l.content)})),$(".gas-form-section-add",a).on("click",H),$(".gas-form-section-del",a).on("click",R),$(`${a}-btn-cancel`,a).on("click",l=>{l.preventDefault();let s=$("#gas-popup-leave-confirmation");s.css({opacity:1,display:"flex"}),$(".gas-popup-btn-close",s).one("click",i=>{i.preventDefault(),s.hide()}),$(".gas-popup-btn-leave",s).one("click",i=>{i.preventDefault(),isUserInputActive=!1,s.hide(),p()})}),$(`${a}-btn-submit`).attr("disabled",!0);let e=$(`${a}-btn-submit`).val(),t=$(".gas-form-error",a),o=$("div",t),r=t.text(),n=$(".gas-form-success",a);$("input[name][required]",a).on("focusout keyup",function(){d($(this))}),$(`${a}-btn-submit`).on("click",async l=>{l.preventDefault(),$(`${a}-btn-submit`).addClass("disabled-button").attr("disabled",!0),isUserInputActive=!1,$(`${a}-btn-submit`).val($(`${a}-btn-submit`).data("wait"));let s=[];$(".gas-form-section",a).each(function(){s.push({title:$("input[name$=-title]",this).val(),content:tinyMCE.get($(".gas-form-tinymce",this).attr("id")).getContent()})});let i={author:"GA user",title:$("[name=guide-title]",a).val(),description:$("[name=guide-description]",a).val(),sections:s},T="POST",A=`https://${v}/api/guide`;if(x)A+=`/${h}`,T="PUT",i.author=c.author,i.profileId=c.profileId;else{if(!userProfileData){t.show(),o.text("Issue on accessing your data for saving. Please try again later."),$(`${a}-btn-submit`).val(e),setTimeout(()=>{t.hide(),o.text(r)},b);return}i.profileId=userProfileData.id,i.author=userProfileData.name,i.achievementId=g}let F=await fetch(A,{method:T,headers:{Authorization:`Bearer ${token}`,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i)}),j=await F.json();if(![200,201].includes(F.status)){t.show(),o.text(j?.message),$(`${a}-btn-submit`).val(e).removeClass("disabled-button").attr("disabled",!1),setTimeout(()=>{t.hide(),o.text(r)},b);return}n.show(),$(`${a}-btn-submit`).val(e),setTimeout(()=>{$(`${a}-fields`).hide()},b/5),setTimeout(()=>{isUserInputActive=!1,n.hide(),p()},b)})}function p(){window.location.replace(x?`/guide?id=${h}`:g>0?`/achievement?id=${g}`:"/guides")}$(async()=>{if(await auth0Bootstrap(),!token){console.log("User not authenticated"),p();return}if(x){if(c=await M(v,h),c?.achievementId>0){let e=await fetch(`https://${v}/api/achievement/${c.achievementId}/guide-auth-user-data`,{headers:{Authorization:`Bearer ${token}`}});if(e.status!==200){console.log("User not found/issue, cannot access to guide edition"),p();return}if(!(await e.json()).ownedGuideId){console.log("This form does not belong to the creator"),p();return}}}else if(g>0)await D(v,g);else{console.log("no valid parameter provided"),p();return}await V(),$(".ga-loader-container").hide(),$("#ga-sections-container").show()});})();
