(()=>{var g=e=>{let t=o=>`0${o}`.slice(-2),s=new Date(e);return`${s.getFullYear()} . ${t(s.getMonth()+1)} . ${t(s.getDate())}`};var x=e=>{if(!e)return"N.A.";let t=e.lastIndexOf(" | ");return t>0?e.slice(0,t):e};var b=document.querySelector("meta[name=domain]")?.content,D=new URLSearchParams(window.location.search),d=Number(D.get("id"))||0,h=d>0,n,u=Number(D.get("achievementId"))||0,a="#gas-guide-form",l=2,F=$(".gas-form-section",a).last().clone();$(".ga-loader-container").show(),$("#ga-sections-container").hide();var A=(e,t)=>!!t&&(isUserInputActive=!0,!0),S=e=>{if((e.hasClass("gas-form-tinymce")?tinyMCE.get(e.attr("id")).getContent():e.val())?.length)return e.prev("label").removeClass("field-label-missing");e.prev("label").addClass("field-label-missing")},v=e=>{let t=!1,s=!1;e?.length&&S(e);for(let o of $("input[name][required]",a))if(t=A($(o),$(o).val()?.length),!t)break;for(let o of $(".gas-form-tinymce",a))if(s=A($(o),tinyMCE.get($(o).attr("id")).getContent()?.length),!s)break;t&&s?$(`${a}-btn-submit`).removeClass("disabled-button").attr("disabled",!1):$(`${a}-btn-submit`).addClass("disabled-button").attr("disabled",!0)},k,w={selector:".gas-form-tinymce",height:200,menubar:!1,toolbar_mode:"floating",plugins:"link image lists",toolbar:"undo redo | bold italic underline | numlist bullist",content_style:"body { font-family:Gantari,sans-serif; font-size:1rem }",setup:e=>{e.on("Paste Change input Undo Redo",()=>{clearTimeout(k),k=setTimeout(()=>v($(e.targetElm)),100)})}};function L(){if(confirm("Do you want to remove this section?")){v();let e=$(this).parents(".gas-form-section");tinyMCE.get($(".gas-form-tinymce",e).attr("id")).remove(),e.remove(),l--,$(".gas-form-section label[for$=-title]",a).each((t,s)=>$(s).text(`${t+1}${$(s).text().slice(1)}`)),l<=4&&$(".gas-form-section-add",a).show()}}async function M(){l++,$(`${a}-btn-submit`).addClass("disabled-button").attr("disabled",!0);let e=F.clone().show(),t=`section-${l}`;$("label[for=section-2-title]",e).text(`${l} \u203A section name*`).attr("for",`${t}-title`),$("[name=section-2-title]",e).attr("name",`${t}-title`).on("focusout keyup",function(){v($(this))}),$("label[for=section-2-content]",e).attr("for",`${t}-content`);let s=`${t}-content`;$(".gas-form-tinymce",e).attr("id",s).attr("name",s).attr("data-name",s),$(".gas-form-section-del",e).on("click",L),$(".gas-form-sections",a).append(e),w.selector=`#${s}`,await tinymce.init(w),l>4&&$(".gas-form-section-add",a).hide()}async function R(){$(".gas-form-tinymce",F).removeAttr("id"),await tinymce.init(w),h&&n?.id===d&&($("[name=guide-title]",a).val(n.name),$("[name=guide-description]",a).val(n.description),n.sections.forEach(async(c,i)=>{i>1&&i<n.sections.length&&await M(),$(`[name=section-${i+1}-title]`).val(c.title),tinyMCE.get(`section-${i+1}-content`).setContent(c.content)})),$(".gas-form-section-add",a).on("click",M),$(".gas-form-section-del",a).on("click",L),$(`${a}-btn-cancel`,a).on("click",c=>{c.preventDefault();let i=$("#gas-popup-leave-confirmation");i.css({opacity:1,display:"flex"}),$(".gas-popup-btn-close",i).one("click",r=>{r.preventDefault(),i.hide()}),$(".gas-popup-btn-leave",i).one("click",r=>{r.preventDefault(),isUserInputActive=!1,i.hide(),m()})}),$(`${a}-btn-submit`).attr("disabled",!0);let e=$(`${a}-btn-submit`).val(),t=$(".gas-form-error",a),s=$("div",t),o=t.text(),p=$(".gas-form-success",a);$("input[name][required]",a).on("focusout keyup",function(){v($(this))}),$(`${a}-btn-submit`).on("click",async c=>{c.preventDefault(),$(`${a}-btn-submit`).addClass("disabled-button").attr("disabled",!0),isUserInputActive=!1,$(`${a}-btn-submit`).val($(`${a}-btn-submit`).data("wait"));let i=[];$(".gas-form-section",a).each(function(){i.push({title:$("input[name$=-title]",this).val(),content:tinyMCE.get($(".gas-form-tinymce",this).attr("id")).getContent()})});let r={author:"GA user",title:$("[name=guide-title]",a).val(),description:$("[name=guide-description]",a).val(),sections:i},y="POST",C=`https://${b}/api/guide`;if(h)C+=`/${d}`,y="PUT",r.author=n.author,r.profileId=n.profileId;else{if(!userProfileData)return t.show(),s.text("Issue on accessing your data for saving. Please try again later."),$(`${a}-btn-submit`).val(e),void setTimeout(()=>{t.hide(),s.text(o)},4e3);r.profileId=userProfileData.id,r.author=userProfileData.name,r.achievementId=u}let T=await fetch(C,{method:y,headers:{Authorization:`Bearer ${token}`,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)}),I=await T.json();if(![200,201].includes(T.status))return t.show(),s.text(I?.message),$(`${a}-btn-submit`).val(e).removeClass("disabled-button").attr("disabled",!1),void setTimeout(()=>{t.hide(),s.text(o)},4e3);p.show(),$(`${a}-btn-submit`).val(e),setTimeout(()=>{$(`${a}-fields`).hide()},800),setTimeout(()=>{isUserInputActive=!1,p.hide(),m()},4e3)})}function f(e,t="#gas-guide-details"){let s=$(t),o=s.prop("outerHTML"),p=["id","name","achievementId","achievementName","gameId","gameName"],c=e.coverURL||e.imageURL;c?.length&&t.endsWith("details")&&(o=s.css("background-image",`linear-gradient(rgba(255,255,255,0),#030922),
          linear-gradient(rgba(70,89,255,.4),rgba(70,89,255,.4)),
          url(${c})`).prop("outerHTML")),Object.entries(e).forEach(([i,r])=>{i==="achievementName"?o=o.replaceAll(`{|${i}|}`,x(r)):p.includes(i)&&(o=o.replaceAll(`{|${i}|}`,(i.endsWith("At")?g(r):r)||""))}),s.prop("outerHTML",o)}async function j(){n=await(await fetch(`https://${b}/api/guide/${d}`)).json(),Object.keys(n).length>0&&n.id&&(document.title=`${n.name?.length?n.name:n.id} | ${document.title}`,f(n),f(n,"#gas-guide-form"))}async function O(){let t=await(await fetch(`https://${b}/api/achievement/${u}`)).json();Object.keys(t).length>0&&t.id&&(document.title=`Achievement ${t.name?.length?t.name:t.id} | ${document.title}`,t.achievementName=t.name,f(t),f(t,"#gas-guide-form"))}function m(){window.location.replace(h?`/guide?id=${d}`:u>0?`/achievement?id=${u}`:"/guides")}$().ready(async()=>{if(await auth0Bootstrap(),token){if(h){if(await j(),n?.achievementId>0){let e=await fetch(`https://${b}/api/achievement/${n.achievementId}/guide-auth-user-data`,{headers:{Authorization:`Bearer ${token}`}});if(e.status!==200||!(await e.json()).ownedGuideId)return void m()}}else{if(!(u>0))return void m();await O()}await R(),$(".ga-loader-container").hide(),$("#ga-sections-container").show()}else m()});})();
